#!/usr/bin/env luajit

-- runs tests in the debug environment
-- please update 'config.lua' for specific settings


-- prepends the debug paths to the Busted commandline
-- and runs a helper to expose the debug globals

-- Load config file, assuming this file is in the 'debug' subdirectory of the Kong source
local prefix = arg[0]:match("^(.+)/").."/../"  -- this file's path, and then one level up
prefix = prefix:gsub("/debug/%.%./", "/"):gsub("^debug/%.%./", "./")

local pp = package.path
package.path = prefix.."debug/?.lua"
print(package.path)
local config = require("config")
package.path = pp

-- write busted helper file
local helperfile = prefix.."debug/busted-helper.lua"
local f = io.open(helperfile, "w")
f:write([[
-- Busted helper file auto-generated by the 'test' script
-- Busted will be started with this file in the --helper=xxx commandline option

-- expose debug globals
debug.start = require("mobdebug").start
debug.stop = require("mobdebug").done

]])
f:close()

local function Q(param) return "'"..param.."'" end  -- quote an argument

-- configure busted
local busted = "cd "..prefix.." && busted --helper="..Q(helperfile).." --lpath="..Q(config.lpath).." --cpath="..Q(config.cpath).." "..config.test_options
for _, param in ipairs(arg) do
  busted = busted .. " '" .. param .."'"
end
print("Executing:", busted)
os.execute(busted)


