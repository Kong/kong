## Kong


### Performance
#### Performance

- Improved proxy performance by refactoring internal hooking mechanism.
 [#12784](https://github.com/Kong/kong/issues/12784)
 [KAG-3653](https://konghq.atlassian.net/browse/KAG-3653)

- Speeded up the router matching when the `router_flavor` is `traditional_compatible` or `expressions`.
 [#12467](https://github.com/Kong/kong/issues/12467)
 [KAG-3653](https://konghq.atlassian.net/browse/KAG-3653)
#### Plugin

- **Opentelemetry**: increase queue max batch size to 200
 [#12488](https://github.com/Kong/kong/issues/12488)
 [KAG-3173](https://konghq.atlassian.net/browse/KAG-3173)

### Breaking Changes
#### Plugin

- **AI-Proxy**: To support the new messages API of `Anthropic`, the upstream path of the `Anthropic` for `llm/v1/chat` route type is changed from `/v1/complete` to `/v1/messages`
 [#12699](https://github.com/Kong/kong/issues/12699)
 [FTI-5770](https://konghq.atlassian.net/browse/FTI-5770)


### Dependencies
#### Core

- Bumped atc-router from v1.6.0 to v1.6.2
 [#12231](https://github.com/Kong/kong/issues/12231)
 [KAG-3403](https://konghq.atlassian.net/browse/KAG-3403)

- Bumped libexpat to 2.6.2
 [#12910](https://github.com/Kong/kong/issues/12910)
 [CVE-2023](https://konghq.atlassian.net/browse/CVE-2023) [CVE-2013](https://konghq.atlassian.net/browse/CVE-2013) [CVE-2024](https://konghq.atlassian.net/browse/CVE-2024) [KAG-4331](https://konghq.atlassian.net/browse/KAG-4331)

- Bumped lua-kong-nginx-module from 0.8.0 to 0.11.0
 [#12752](https://github.com/Kong/kong/issues/12752)
 [KAG-4050](https://konghq.atlassian.net/browse/KAG-4050)

- Bump lua-protobuf to 0.5.1
 [#12834](https://github.com/Kong/kong/issues/12834)


- Bumped lua-resty-acme to 0.13.0
 [#12909](https://github.com/Kong/kong/issues/12909)
 [KAG-4330](https://konghq.atlassian.net/browse/KAG-4330)

- Bumped lua-resty-aws from 1.3.6 to 1.4.1
 [#12846](https://github.com/Kong/kong/issues/12846)
 [KAG-3424](https://konghq.atlassian.net/browse/KAG-3424) [FTI-5732](https://konghq.atlassian.net/browse/FTI-5732)

- Bumped lua-resty-lmdb from 1.4.1 to 1.4.2
 [#12786](https://github.com/Kong/kong/issues/12786)


- Bumped lua-resty-openssl from 1.2.0 to 1.3.1
 [#12665](https://github.com/Kong/kong/issues/12665)


- Bumped lua-resty-timer-ng to 0.2.7
 [#12756](https://github.com/Kong/kong/issues/12756)
 [KAG-3653](https://konghq.atlassian.net/browse/KAG-3653)

- Bumped PCRE from the legacy libpcre 8.45 to libpcre2 10.43
 [#12366](https://github.com/Kong/kong/issues/12366)
 [KAG-3571](https://konghq.atlassian.net/browse/KAG-3571) [KAG-3521](https://konghq.atlassian.net/browse/KAG-3521) [KAG-2025](https://konghq.atlassian.net/browse/KAG-2025)

- Bumped penlight to 1.14.0
 [#12862](https://github.com/Kong/kong/issues/12862)

#### Default

- Add package `tzdata` to DEB Docker image for convenient timezone setting.
 [#12609](https://github.com/Kong/kong/issues/12609)
 [FTI-5698](https://konghq.atlassian.net/browse/FTI-5698)

- Bump lua-resty-http to 0.17.2.
 [#12908](https://github.com/Kong/kong/issues/12908)


- Bumped LuaRocks from 3.9.2 to 3.11.0
 [#12662](https://github.com/Kong/kong/issues/12662)
 [KAG-3883](https://konghq.atlassian.net/browse/KAG-3883)

- Bump `ngx_wasm_module` to `91d447ffd0e9bb08f11cc69d1aa9128ec36b4526`
 [#12011](https://github.com/Kong/kong/issues/12011)


- Bump `V8` version to `12.0.267.17`
 [#12704](https://github.com/Kong/kong/issues/12704)


- Bump `Wasmtime` version to `19.0.0`
 [#12011](https://github.com/Kong/kong/issues/12011)


- Improve the robustness of lua-cjson when handling unexpected input.
 [#12904](https://github.com/Kong/kong/issues/12904)
 [KAG-4275](https://konghq.atlassian.net/browse/KAG-4275)

### Features
#### Configuration

- now TLSv1.1 and lower is by default disabled in OpenSSL 3.x
 [#12420](https://github.com/Kong/kong/issues/12420)
 [KAG-3259](https://konghq.atlassian.net/browse/KAG-3259)

- Introduce `nginx_wasm_main_shm_kv` configuration entry, which enables
Wasm filters to use the Proxy-Wasm operations `get_shared_data` and
`set_shared_data` without namespaced keys.
 [#12663](https://github.com/Kong/kong/issues/12663)


- **Schema**: Added a deprecation field attribute to identify deprecated fields
 [#12686](https://github.com/Kong/kong/issues/12686)
 [KAG-3915](https://konghq.atlassian.net/browse/KAG-3915)

- Add `wasm_filters` configuration value for enabling individual filters
 [#12843](https://github.com/Kong/kong/issues/12843)
 [KAG-4211](https://konghq.atlassian.net/browse/KAG-4211)
#### Core

- Add `events:ai:response_tokens`, `events:ai:prompt_tokens` and `events:ai:requests` to the anonymous report to start counting AI usage
 [#12924](https://github.com/Kong/kong/issues/12924)


- Supported fields `methods`, `hosts`, `paths`, `headers`,
`snis`, `sources`, `destinations` and `regex_priority`
for the `route` entity when the `router_flavor` is `expressions`.
The meaning of these fields are consistent with the traditional route entity.
 [#12667](https://github.com/Kong/kong/issues/12667)
 [KAG-3805](https://konghq.atlassian.net/browse/KAG-3805) [KAG-3807](https://konghq.atlassian.net/browse/KAG-3807)

- Added a new function to bypass the Kong's DNS client synchronization option
when resolving hostnames.
 [#12739](https://github.com/Kong/kong/issues/12739)
 [KAG-3795](https://konghq.atlassian.net/browse/KAG-3795)
#### PDK

- Add `latencies.receive` property to log serializer
 [#12730](https://github.com/Kong/kong/issues/12730)
 [KAG-3798](https://konghq.atlassian.net/browse/KAG-3798)
#### Plugin

- AI Proxy now reads most prompt tuning parameters from the client, whilst the
plugin config 'model options' are now just defaults. This fixes support for 
using the respective provider's native SDK.
 [#12903](https://github.com/Kong/kong/issues/12903)
 [KAG-4126](https://konghq.atlassian.net/browse/KAG-4126)

- AI Proxy now has a 'preserve' route_type option, where the requests and responses 
are passed directly to the upstream LLM. This is to enable compatilibity with any  
and all models and SDKs, that may be used when calling the AI services.
 [#12903](https://github.com/Kong/kong/issues/12903)
 [KAG-4126](https://konghq.atlassian.net/browse/KAG-4126)

- **Prometheus**: Added workspace label to Prometheus plugin metrics.
 [#12836](https://github.com/Kong/kong/issues/12836)
 [FTI-5573](https://konghq.atlassian.net/browse/FTI-5573)

- **AI-Proxy**: add support for streaming event-by-event responses back to client on supported providers
 [#12792](https://github.com/Kong/kong/issues/12792)
 [KAG-4124](https://konghq.atlassian.net/browse/KAG-4124)

- **AI-Prompt-Guard**: increase the maximum length of regex expression to 500 for both allow and deny parameter
 [#12731](https://github.com/Kong/kong/issues/12731)
 [FTI-5767](https://konghq.atlassian.net/browse/FTI-5767)

- Addded support for EdDSA algorithms in JWT plugin
 [#12726](https://github.com/Kong/kong/issues/12726)


- Added support for ES512, PS256, PS384, PS512 algorithms in JWT plugin
 [#12638](https://github.com/Kong/kong/issues/12638)
 [KAG-3821](https://konghq.atlassian.net/browse/KAG-3821)

- **OpenTelemetry, Zipkin**: the propagation module has been reworked, new
options allow better control over the configuration of tracing headers propagation.
 [#12670](https://github.com/Kong/kong/issues/12670)
 [KAG-1886](https://konghq.atlassian.net/browse/KAG-1886) [KAG-1887](https://konghq.atlassian.net/browse/KAG-1887)
#### Clustering

- Remote procedure call (RPC) framework for Hybrid mode deployments.
 [#12320](https://github.com/Kong/kong/issues/12320)
 [KAG-623](https://konghq.atlassian.net/browse/KAG-623) [KAG-3751](https://konghq.atlassian.net/browse/KAG-3751)

- Dynamic log level over Hybrid mode RPC which allows setting DP log level
to a different level for specified duration before reverting back
to the `kong.conf` configured value.
 [#12320](https://github.com/Kong/kong/issues/12320)
 [KAG-623](https://konghq.atlassian.net/browse/KAG-623) [KAG-3751](https://konghq.atlassian.net/browse/KAG-3751)
#### Default

- Added support for debugging with EmmyLuaDebugger
 [#12899](https://github.com/Kong/kong/issues/12899)
 [KAG-4316](https://konghq.atlassian.net/browse/KAG-4316)

### Fixes
#### Configuration

- Fixed default value in kong.conf.default documentation from 1000 to 10000
for upstream_keepalive_max_requests option.
 [#12643](https://github.com/Kong/kong/issues/12643)
 [KAG-3360](https://konghq.atlassian.net/browse/KAG-3360)

- Fix an issue where an external plugin (Go, Javascript, or Python) would fail to
apply a change to the plugin config via the Admin API.
 [#12718](https://github.com/Kong/kong/issues/12718)
 [KAG-3949](https://konghq.atlassian.net/browse/KAG-3949)

- Disable usage of the Lua DNS resolver from proxy-wasm by default.
 [#12825](https://github.com/Kong/kong/issues/12825)
 [KAG-4277](https://konghq.atlassian.net/browse/KAG-4277)

- Set security level of gRPC's TLS to 0 when ssl_cipher_suite is set to old
 [#12613](https://github.com/Kong/kong/issues/12613)
 [KAG-3259](https://konghq.atlassian.net/browse/KAG-3259)
#### Core

- Fixed an issue wherein `POST /config?flatten_errors=1` could not return a proper response if the input included duplicate upstream targets
 [#12797](https://github.com/Kong/kong/issues/12797)
 [KAG-4144](https://konghq.atlassian.net/browse/KAG-4144)

- **DNS Client**: Ignore a non-positive values on resolv.conf for options timeout, and use a default value of 2 seconds instead.
 [#12640](https://github.com/Kong/kong/issues/12640)
 [FTI-5791](https://konghq.atlassian.net/browse/FTI-5791)

- update file permission of kong.logrotate to 644
 [#12629](https://github.com/Kong/kong/issues/12629)
 [FTI-5756](https://konghq.atlassian.net/browse/FTI-5756)

- Fixed a problem that in hybrid DP mode a certificate entity configured with vault reference may not get refreshed on time
 [#12868](https://github.com/Kong/kong/issues/12868)
 [FTI-5881](https://konghq.atlassian.net/browse/FTI-5881)

- Fix the missing router section for the output of the request-debugging
 [#12234](https://github.com/Kong/kong/issues/12234)
 [KAG-3438](https://konghq.atlassian.net/browse/KAG-3438)

- Fixed an issue that leaking locks in the internal caching logic
 [#12743](https://github.com/Kong/kong/issues/12743)


- Fixed an issue where router may not work correctly
when the routes configuration changed.
 [#12654](https://github.com/Kong/kong/issues/12654)
 [KAG-3857](https://konghq.atlassian.net/browse/KAG-3857)

- Fixed an issue where SNI-based routing does not work
using tls_passthrough and the traditional_compatible router flavor
 [#12681](https://github.com/Kong/kong/issues/12681)
 [KAG-3922](https://konghq.atlassian.net/browse/KAG-3922) [FTI-5781](https://konghq.atlassian.net/browse/FTI-5781)

- fix a bug that `X-Kong-Upstream-Status` will not appear in the response headers even if it is set in the `headers` parameter in the kong.conf when the response is hit and returned by proxy cache plugin.
 [#12744](https://github.com/Kong/kong/issues/12744)
 [FTI-5827](https://konghq.atlassian.net/browse/FTI-5827)

- fix vault initialization by postponing vault reference resolving on init_worker
 [#12554](https://github.com/Kong/kong/issues/12554)
 [KAG-2907](https://konghq.atlassian.net/browse/KAG-2907)

- Fixed a bug that allowed vault secrets to refresh even when they had no TTL set.
 [#12877](https://github.com/Kong/kong/issues/12877)
 [FTI-5906](https://konghq.atlassian.net/browse/FTI-5906) [FTI-5916](https://konghq.atlassian.net/browse/FTI-5916)

- **Vault**: do not use incorrect (default) workspace identifier when retrieving vault entity by prefix
 [#12572](https://github.com/Kong/kong/issues/12572)
 [FTI-5762](https://konghq.atlassian.net/browse/FTI-5762)

- **Core**: Fixed unexpected table nil panic in the balancer's stop_healthchecks function
 [#12865](https://github.com/Kong/kong/issues/12865)


- Use `-1` as the worker ID of privileged agent to avoid access issues.
 [#12385](https://github.com/Kong/kong/issues/12385)
 [FTI-5707](https://konghq.atlassian.net/browse/FTI-5707)

- **Plugin Server**: fix an issue where Kong fails to properly restart MessagePack-based pluginservers (used in Python and Javascript plugins, for example)
 [#12582](https://github.com/Kong/kong/issues/12582)
 [KAG-3765](https://konghq.atlassian.net/browse/KAG-3765)

- revert the hard-coded limitation of the ngx.read_body() API in OpenResty upstreams' new versions when downstream connections are in HTTP/2 or HTTP/3 stream modes.
 [#12658](https://github.com/Kong/kong/issues/12658)
 [FTI-5766](https://konghq.atlassian.net/browse/FTI-5766) [FTI-5795](https://konghq.atlassian.net/browse/FTI-5795)

- Each Kong cache instance now utilizes its own cluster event channel. This approach isolates cache invalidation events and reducing the generation of unnecessary worker events.
 [#12321](https://github.com/Kong/kong/issues/12321)
 [FTI-5559](https://konghq.atlassian.net/browse/FTI-5559)

- Update telemetry collection for AI Plugins to allow multiple plugins data to be set for the same request.
 [#12583](https://github.com/Kong/kong/issues/12583)
 [KAG-3759](https://konghq.atlassian.net/browse/KAG-3759) [KAG-4124](https://konghq.atlassian.net/browse/KAG-4124)
#### PDK

- **PDK:** fix kong.request.get_forwarded_port to always return a number which was caused by an incorrectly
stored string value in ngx.ctx.host_port.
 [#12806](https://github.com/Kong/kong/issues/12806)
 [KAG-4158](https://konghq.atlassian.net/browse/KAG-4158)

- The value of `latencies.kong` in the log serializer payload no longer includes
the response receive time, so it now has the same value as the
`X-Kong-Proxy-Latency` response header. Response receive time is recorded in
the new `latencies.receive` metric, so if desired, the old value can be
calculated as `latencies.kong + latencies.receive`. **Note:** this also
affects payloads from all logging plugins that use the log serializer:
`file-log`, `tcp-log`, `udp-log`,`http-log`, `syslog`, and `loggly`.
 [#12795](https://github.com/Kong/kong/issues/12795)
 [KAG-3798](https://konghq.atlassian.net/browse/KAG-3798)

- **Tracing**: enhanced robustness of trace ID parsing
 [#12848](https://github.com/Kong/kong/issues/12848)
 [KAG-4218](https://konghq.atlassian.net/browse/KAG-4218)
#### Plugin

- **AI-proxy-plugin**: Fix the bug that the route_type `/llm/v1/chat` does not include the analytics in the responses.
 [#12781](https://github.com/Kong/kong/issues/12781)
 [FTI-5769](https://konghq.atlassian.net/browse/FTI-5769)

- **ACME**: Fixed an issue where the certificate was not successfully renewed during ACME renewal.
 [#12773](https://github.com/Kong/kong/issues/12773)
 [KAG-4008](https://konghq.atlassian.net/browse/KAG-4008)

- **AWS-Lambda**: fix an issue that the latency attributed to AWS Lambda API requests will be counted as part of the latency in Kong
 [#12835](https://github.com/Kong/kong/issues/12835)
 [FTI-5261](https://konghq.atlassian.net/browse/FTI-5261)

- **Jwt**: fix an issue where the plugin would fail when using invalid public keys for ES384 and ES512 algorithms.
 [#12724](https://github.com/Kong/kong/issues/12724)


- Add WWW-Authenticate headers to all 401 response in key auth plugin.
 [#11794](https://github.com/Kong/kong/issues/11794)
 [KAG-321](https://konghq.atlassian.net/browse/KAG-321)

- **Opentelemetry**: fix otel sampling mode lua panic bug when http_response_header_for_traceid option enable
 [#12544](https://github.com/Kong/kong/issues/12544)
 [FTI-5742](https://konghq.atlassian.net/browse/FTI-5742)
#### Admin API

- **Admin API**: fixed an issue where calling the endpoint `POST /schemas/vaults/validate` was conflicting with the endpoint `/schemas/vaults/:name` which only has GET implemented, hence resulting in a 405.
 [#12607](https://github.com/Kong/kong/issues/12607)
 [KAG-3699](https://konghq.atlassian.net/browse/KAG-3699)
#### Default

- Fix a bug where the ulimit setting (open files) is low Kong will fail to start as the lua-resty-timer-ng exhausts the available worker_connections. Decrease the concurrency range of the lua-resty-timer-ng library from [512, 2048] to [256, 1024] to fix this bug.
 [#12606](https://github.com/Kong/kong/issues/12606)
 [KAG-3779](https://konghq.atlassian.net/browse/KAG-3779) [FTI-5780](https://konghq.atlassian.net/browse/FTI-5780)

- Fix an issue where external plugins using the protobuf-based protocol would fail to call the `kong.Service.SetUpstream` method with an error `bad argument #2 to 'encode' (table expected, got boolean)`.
 [#12727](https://github.com/Kong/kong/issues/12727)

