From edfa0f984ec60bd0658b80643c2fd253f3c5ad0b Mon Sep 17 00:00:00 2001
From: attenuation <ouyangjun1999@gmail.com>
Date: Sun, 21 Aug 2022 21:59:28 +0800
Subject: [PATCH] feat: add ngx_http_lua_ffi_worker_pids to get all workers pid
 map

---

diff --git a/bundle/ngx_lua-0.10.20/src/ngx_http_lua_worker.c b/bundle/ngx_lua-0.10.20/src/ngx_http_lua_worker.c
index 0ca2d414e3..52ec34a844 100644
--- a/bundle/ngx_lua-0.10.20/src/ngx_http_lua_worker.c
+++ b/bundle/ngx_lua-0.10.20/src/ngx_http_lua_worker.c
@@ -8,6 +8,7 @@
 #define DDEBUG 0
 #endif
 #include "ddebug.h"
+#include <ngx_channel.h>
 
 
 #define NGX_PROCESS_PRIVILEGED_AGENT    99
@@ -20,6 +21,36 @@ ngx_http_lua_ffi_worker_pid(void)
 }
 
 
+int
+ngx_http_lua_ffi_worker_pids(int *pids, size_t *pids_len)
+{
+    ngx_int_t i, n;
+
+    n = 0;
+    for (i = 0; i < NGX_MAX_PROCESSES; i++) {
+        if (i != ngx_process_slot && ngx_processes[i].pid == 0) {
+            break;
+        }
+
+        if (i == ngx_process_slot && ngx_processes[i].pid == 0) {
+            pids[n++] = ngx_pid;
+        }
+
+        if (ngx_processes[i].pid > 0) {
+            pids[n++] = ngx_processes[i].pid;
+        }
+    }
+
+    if (n == 0) {
+        return NGX_ERROR;
+    }
+
+    *pids_len = n;
+
+    return NGX_OK;
+}
+
+
 int
 ngx_http_lua_ffi_worker_id(void)
 {