name: Build & Test

on: [push, pull_request]

jobs:
  build:
    name: Build
    runs-on: ubuntu-18.04

    steps:
    - name: Set env
      run: |
          echo "::set-env name=KONG_SOURCE_LOCATION::$GITHUB_WORKSPACE"
          echo "::set-env name=KONG_BUILD_TOOLS_LOCATION::$HOME/kong-build-tools"
        
    - uses: azure/docker-login@v1
      with:
        username: ${{ secrets.KONG_USERNAME }}
        password: ${{ secrets.KONG_PASSWORD }}

    - name: Checkout Kong source code
      uses: actions/checkout@v2

    - name: Setup Kong Build Tools
      run: make setup-kong-build-tools

    - name: Build Test Image
      run: pushd $KONG_BUILD_TOOLS_LOCATION && make kong-test-container && popd

  package-and-smoke-test:
    name: Package and smoke test Kong
    runs-on: ubuntu-18.04
    
    steps:
    - name: Set env
      run: |
          echo "::set-env name=KONG_SOURCE_LOCATION::$GITHUB_WORKSPACE"
          echo "::set-env name=KONG_BUILD_TOOLS_LOCATION::$HOME/kong-build-tools"
          
    - uses: azure/docker-login@v1
      with:
        username: ${{ secrets.KONG_USERNAME }}
        password: ${{ secrets.KONG_PASSWORD }}

    - name: Checkout Kong source code
      uses: actions/checkout@v2

    - name: Setup Kong Build Tools
      run: make setup-kong-build-tools
    
    - name: Package Kong
      run: pushd $HOME/kong-build-tools && make package-kong
      
    - name: Smoke Test Kong
      run: pushd $HOME/kong-build-tools && make test

