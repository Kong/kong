lua_shared_dict req_count 1m;

upstream my_upstream {
    server 127.0.0.1:62341;
    keepalive 16;
}

server {
    listen 62340;

    location /pure_ngx_balancer {
        proxy_pass http://my_upstream;
        proxy_set_header Connection "keep-alive";
    }
}

limit_req_zone $binary_remote_addr zone=mylimit:10m rate=1r/m;

server {
    listen 62341;
    location / {
        content_by_lua_block {
            local dict = ngx.shared.req_count
            local count = dict:get("count") or 0

            if count >= 1 then
                ngx.exit(ngx.HTTP_CLOSE)
            end

            dict:set("count", count + 1)
            ngx.say(ngx.var.server_port)
        }
    }
}

